# rate limit header and para

```
frontend website
    bind :80
    stick-table type string len 2 size 100k expire 10s store http_req_rate(10s)
    http-request track-sc0 base32+src
    http-request set-var(req.rate_limit)  path,map_beg(/etc/haproxy/rates.map,2)
    http-request set-var(req.request_rate)  base32+src,table_http_req_rate()
    acl rate_abuse var(req.rate_limit),sub(req.request_rate) lt 0
    acl exceeds_limit url_param(token),table_http_req_rate() gt 2
    acl exceeds_limit hdr_beg(Authorization),table_http_req_rate() gt 2
    acl has_token url_param(token) -m  found
    acl is_upload hdr_beg(Authorization) -m found
    http-request track-sc0 url_param(token) unless exceeds_limit
    http-request track-sc0 hdr(Authorization) unless exceeds_limit
    http-request deny deny_status 429 if rate_abuse
    http-request allow if has_token or is_upload
    http-request deny deny_status 429 if !has_token || !is_upload or exceeds_limit
    default_backend servers

```

code 2 

```
frontend app
    bind :80
    stick-table type string size 100k expire 10s store http_req_rate(10s)
    http-request track-sc0 hdr(Authorization)
    acl has_hdr hdr_beg(Authorization) -m found
    http-request deny deny_status 429 if { hdr(Authorization),table_http_req_rate() gt 2 }

    http-request track-sc0 url_param
    acl has_token url_param(token) -m  found
    http-request deny deny_status 429 if { url_param,table_http_req_rate() gt 2 }
    http-request allow if has_token or has_hdr
    http-request deny deny_status 429 if !has_token || !has_hdr
#    default_backend servers

frontend app2
    bind :80
    stick-table type binary size 100k expire 10s store http_req_rate(10s)
    http-request track-sc0 base32+src
    http-request set-var(req.rate_limit)  path,map_beg(/etc/haproxy/rates.map,5)
    http-request set-var(req.request_rate)  base32+src,table_http_req_rate()
    acl rate_url var(req.rate_limit),sub(req.request_rate) lt 0
    http-request deny deny_status 429 if rate_url
    default_backend servers
```
ansible
file config.yml

````

---
    - name: Install pre-requisite packages
      yum: name={{ item }} state=latest update_cache=yes
      loop: [ 'yum-utils', 'device-mapper-persistent-data', 'py-pip',  'python3-dev', 'libffi-dev', 'openssl-dev', 'gcc', 'libc-dev', 'rust', 'cargo', 'make', 'alpine', 'lvm2' ]

    - name: Add Docker Repository
      get_url:
        url: https://download.docker.com/linux/centos/docker-ce.repo
        dest: /etc/yum.repos.d/docker-ce.repo

    - name: download and install Docker compose
      get_url:
        url: https://github.com/docker/compose/releases/download/1.29.2/docker-compose
        dest: /usr/local/bin/docker-compose
        mode: 0755

    - name: Create symbolic link
      file:
        src:  /usr/local/bin/docker-compose
        dest: /usr/bin/docker-compose
        state: link

    - name: Update and install docker-ce
      yum: update_cache=yes name=docker-ce state=latest

    - name: Pull default Docker image
      docker_image:
        name: "{{ default_container_image }}"
        source: pull

    - name: Create default containers
      docker_container:
        name: "{{ default_container_name }}{{ item }}"
        image: "{{ default_container_image }}"
        command: "{{ default_container_command }}"
        state: present
      with_sequence: count={{ create_containers }}
      ````
file handlers
main.yml
  ````
 ---
 - name: restart nginx service
  service: name=docker state=restarted
 ````

file default.yml

 ````
---
create_containers: 4
default_container_name: docker
default_container_image: centos:7
default_container_command: sleep 1d
 ````

file config two
 ````
 - name: Create Yum Repo
        yum_repository:
          name: "docker"
          description: "this is a docker repo"
          reposdir: "/etc/yum.repos.d/"
          baseurl: "https://download.docker.com/linux/centos/7/x86_64/stable/"
          gpgcheck : "no"
          enabled: yes
          
 - name: Run Yum RepoList
        command: yum repolist
        
 - name: Run Docker CMD
        command: yum install -y --nobest docker-ce

 - name: Check Package
        package:
          name: "docker-ce"
          state: present

 - name: Check Service
        service:
          name: docker
          state: started
          enabled: yes
          
 - name: Install Docker SDK
          command: "pip3 install docker-py"

 - name: Pull IMG From DockerHub
          docker_image:
            name: "vimal13/apache-webserver-php:v1"
            source: pull
                    
 - name: Run Container
          docker_container:
            name: "container1"
            image: "vimal13/apache-webserver-php:v1"
            state: started
            detach: yes
            exposed_ports:
                 - 80
            ports:
                 - "8080:80"

 - name: Initiate HTTPD on Docker
          command: "systemctl start httpd.service"

 - name: Get Container Details
          docker_container_info:
            name: "container1"
            register: result

 - name: Copy File To TN
          copy:
            src: "demo1.html"
            dest: "/root"

 - name: Copy File To Docker Container
          command: "docker cp /root/demo1.html container1:/var/www/html"
 ````


